# üìö BU·ªîI 6 - USER MANAGEMENT ADVANCED

## Advanced Features & Production Ready

---

## üéØ T·ªïng quan Bu·ªïi 6

**M·ª•c ti√™u**: N√¢ng c·∫•p h·ªá th·ªëng User Management t·ª´ c∆° b·∫£n l√™n professional v·ªõi c√°c t√≠nh nƒÉng n√¢ng cao v√† s·∫µn s√†ng production.

**Prerequisites**: ƒê√£ ho√†n th√†nh Bu·ªïi 5 v·ªõi ƒë·∫ßy ƒë·ªß authentication, profile management, admin panel, v√† forgot/reset password.

---

## üöÄ HO·∫†T ƒê·ªòNG 1: Real-time Notifications v·ªõi Socket.IO

### M·ª•c ti√™u:

- Th√™m th√¥ng b√°o real-time cho admin khi c√≥ user m·ªõi ƒëƒÉng k√Ω
- Hi·ªÉn th·ªã tr·∫°ng th√°i online/offline c·ªßa users
- Live updates trong admin dashboard
- Notification center cho users

### Backend Implementation:

1. **Install dependencies**:

```bash
npm install socket.io cors
```

2. **Socket Server Setup** (`backend/socket/socketServer.js`):

```javascript
const socketIO = require("socket.io");
const jwt = require("jsonwebtoken");
const User = require("../models/User");

let io;
const connectedUsers = new Map(); // userId -> socketId

const initializeSocket = (server) => {
  io = socketIO(server, {
    cors: {
      origin: "http://localhost:3000",
      methods: ["GET", "POST"],
    },
  });

  // Socket authentication middleware
  io.use(async (socket, next) => {
    try {
      const token = socket.handshake.auth.token;
      if (!token) {
        return next(new Error("Authentication error"));
      }

      const decoded = jwt.verify(
        token,
        process.env.JWT_SECRET || "your_jwt_secret_key_2024"
      );
      const user = await User.findById(decoded.id);

      socket.userId = user._id.toString();
      socket.userRole = user.role;
      next();
    } catch (err) {
      next(new Error("Authentication error"));
    }
  });

  io.on("connection", (socket) => {
    // User connected
    connectedUsers.set(socket.userId, socket.id);

    // Notify admins about new connection
    socket.broadcast.to("admins").emit("userOnline", {
      userId: socket.userId,
      timestamp: new Date(),
    });

    // Join admin room if user is admin
    if (socket.userRole === "admin") {
      socket.join("admins");
    }

    // Handle disconnection
    socket.on("disconnect", () => {
      connectedUsers.delete(socket.userId);

      // Notify admins about disconnection
      socket.broadcast.to("admins").emit("userOffline", {
        userId: socket.userId,
        timestamp: new Date(),
      });
    });
  });

  return io;
};

// Helper functions
const notifyAdmins = (event, data) => {
  if (io) {
    io.to("admins").emit(event, data);
  }
};

const notifyUser = (userId, event, data) => {
  const socketId = connectedUsers.get(userId);
  if (socketId && io) {
    io.to(socketId).emit(event, data);
  }
};

const getOnlineUsers = () => {
  return Array.from(connectedUsers.keys());
};

module.exports = {
  initializeSocket,
  notifyAdmins,
  notifyUser,
  getOnlineUsers,
};
```

3. **Update server.js**:

```javascript
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const http = require("http");
const { initializeSocket } = require("./socket/socketServer");
require("dotenv").config();

const app = express();
const server = http.createServer(app);

// Initialize Socket.IO
const io = initializeSocket(server);

// ... existing middleware and routes ...

const PORT = process.env.PORT || 5000;
server.listen(PORT, () => console.log(`üöÄ Server running on port ${PORT}`));
```

### Frontend Implementation:

1. **Install dependencies**:

```bash
npm install socket.io-client react-toastify
```

2. **Socket Context** (`frontend/src/context/SocketContext.js`):

```javascript
import React, { createContext, useContext, useEffect, useState } from "react";
import io from "socket.io-client";

const SocketContext = createContext();

export const useSocket = () => {
  return useContext(SocketContext);
};

export const SocketProvider = ({ children }) => {
  const [socket, setSocket] = useState(null);
  const [onlineUsers, setOnlineUsers] = useState([]);
  const [notifications, setNotifications] = useState([]);

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) {
      const newSocket = io("http://localhost:5000", {
        auth: { token },
      });

      setSocket(newSocket);

      // Listen for events
      newSocket.on("userOnline", (data) => {
        setOnlineUsers((prev) => [...prev, data.userId]);
        addNotification("info", `User ${data.userId} is now online`);
      });

      newSocket.on("userOffline", (data) => {
        setOnlineUsers((prev) => prev.filter((id) => id !== data.userId));
        addNotification("info", `User ${data.userId} went offline`);
      });

      newSocket.on("newUserRegistered", (data) => {
        addNotification("success", `New user registered: ${data.name}`);
      });

      return () => newSocket.close();
    }
  }, []);

  const addNotification = (type, message) => {
    const notification = {
      id: Date.now(),
      type,
      message,
      timestamp: new Date(),
    };
    setNotifications((prev) => [notification, ...prev.slice(0, 49)]); // Keep last 50
  };

  const removeNotification = (id) => {
    setNotifications((prev) => prev.filter((n) => n.id !== id));
  };

  const value = {
    socket,
    onlineUsers,
    notifications,
    addNotification,
    removeNotification,
  };

  return (
    <SocketContext.Provider value={value}>{children}</SocketContext.Provider>
  );
};
```

### Screenshots c·∫ßn ch·ª•p (5 ·∫£nh):

1. Admin Dashboard hi·ªÉn th·ªã users online/offline real-time
2. Toast notification khi c√≥ user m·ªõi ƒëƒÉng k√Ω
3. Notification center v·ªõi l·ªãch s·ª≠ th√¥ng b√°o
4. Browser DevTools showing Socket.IO connection
5. Postman test Socket events v·ªõi auth token

---

## üöÄ HO·∫†T ƒê·ªòNG 2: Email Integration System

### M·ª•c ti√™u:

- Thay th·∫ø demo mode forgot-password b·∫±ng email th·∫≠t
- G·ª≠i welcome email khi ƒëƒÉng k√Ω
- Email notifications cho admin actions
- Email templates ƒë·∫πp v·ªõi HTML

### Backend Implementation:

1. **Install dependencies**:

```bash
npm install nodemailer handlebars
```

2. **Email Service** (`backend/services/emailService.js`):

```javascript
const nodemailer = require("nodemailer");
const handlebars = require("handlebars");
const fs = require("fs");
const path = require("path");

// Create transporter
const createTransporter = () => {
  return nodemailer.createTransporter({
    service: "gmail", // or your email service
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS, // App password for Gmail
    },
  });
};

// Load email template
const loadTemplate = (templateName, variables) => {
  const templatePath = path.join(
    __dirname,
    "../templates",
    `${templateName}.hbs`
  );
  const templateSource = fs.readFileSync(templatePath, "utf8");
  const template = handlebars.compile(templateSource);
  return template(variables);
};

// Send welcome email
const sendWelcomeEmail = async (userEmail, userName) => {
  try {
    const transporter = createTransporter();
    const html = loadTemplate("welcome", {
      userName,
      loginUrl: `${process.env.FRONTEND_URL}/login`,
    });

    await transporter.sendMail({
      from: process.env.EMAIL_USER,
      to: userEmail,
      subject: "üéâ Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi h·ªá th·ªëng!",
      html,
    });

    console.log("‚úÖ Welcome email sent to:", userEmail);
  } catch (error) {
    console.error("‚ùå Error sending welcome email:", error);
  }
};

// Send password reset email
const sendPasswordResetEmail = async (userEmail, resetToken, userName) => {
  try {
    const transporter = createTransporter();
    const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;

    const html = loadTemplate("passwordReset", {
      userName,
      resetUrl,
      expiryTime: "30 ph√∫t",
    });

    await transporter.sendMail({
      from: process.env.EMAIL_USER,
      to: userEmail,
      subject: "üîê Y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u",
      html,
    });

    console.log("‚úÖ Password reset email sent to:", userEmail);
  } catch (error) {
    console.error("‚ùå Error sending password reset email:", error);
  }
};

module.exports = {
  sendWelcomeEmail,
  sendPasswordResetEmail,
};
```

3. **Email Templates**:

- Create `backend/templates/welcome.hbs`
- Create `backend/templates/passwordReset.hbs`

### Screenshots c·∫ßn ch·ª•p (4 ·∫£nh):

1. Welcome email trong Gmail/inbox
2. Password reset email v·ªõi working link
3. Environment variables setup
4. Email service logs trong terminal

---

## üöÄ HO·∫†T ƒê·ªòNG 3: Advanced Permission System

### M·ª•c ti√™u:

- Granular permissions (read, write, delete) cho t·ª´ng resource
- Permission groups v√† inheritance
- Resource-based access control
- Dynamic permission checking

### Backend Implementation:

1. **Permission Model** (`backend/models/Permission.js`):

```javascript
const mongoose = require("mongoose");

const permissionSchema = new mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
      unique: true,
    },
    resource: {
      type: String,
      required: true, // 'users', 'profiles', 'system'
      enum: ["users", "profiles", "system", "reports"],
    },
    action: {
      type: String,
      required: true, // 'read', 'write', 'delete'
      enum: ["read", "write", "delete", "manage"],
    },
    description: String,
  },
  { timestamps: true }
);

// Compound index for resource + action
permissionSchema.index({ resource: 1, action: 1 });

module.exports = mongoose.model("Permission", permissionSchema);
```

2. **Enhanced User Model** (update existing):

```javascript
// Add to User schema
permissions: [{
  type: mongoose.Schema.Types.ObjectId,
  ref: 'Permission'
}],
permissionGroups: [{
  type: String,
  enum: ['basic_user', 'moderator', 'admin', 'super_admin']
}]
```

### Screenshots c·∫ßn ch·ª•p (3 ·∫£nh):

1. Permission management interface
2. User v·ªõi different permission levels
3. API response v·ªõi permission checks

---

## üöÄ HO·∫†T ƒê·ªòNG 4: Advanced Admin Features

### M·ª•c ti√™u:

- Bulk operations (bulk delete, bulk email)
- Advanced search v√† filtering
- User analytics v√† charts
- Data export (CSV, Excel)
- System monitoring dashboard

### Features to implement:

1. **User Analytics Dashboard**
2. **Bulk User Operations**
3. **Advanced Search & Filtering**
4. **Data Export Functionality**
5. **System Health Monitoring**

### Screenshots c·∫ßn ch·ª•p (6 ·∫£nh):

1. Analytics dashboard v·ªõi charts
2. Bulk operations interface
3. Advanced search filters
4. Export functionality working
5. System monitoring stats
6. Performance metrics

---

## üìä T·ªïng k·∫øt Bu·ªïi 6

### T·ªïng s·ªë t√≠nh nƒÉng m·ªõi: 15+

### T·ªïng s·ªë API endpoints m·ªõi: 12+

### T·ªïng s·ªë screenshots y√™u c·∫ßu: 18

### Skills h·ªçc ƒë∆∞·ª£c:

- Real-time programming v·ªõi Socket.IO
- Email service integration
- Advanced security patterns
- Performance optimization
- Production deployment preparation

---

## üöÄ Demo v√† Deployment

### Local Development:

```bash
# Backend
cd backend
npm install
node server.js

# Frontend
cd frontend
npm install
npm start
```

### Production Deployment:

- Railway/Render cho backend
- Vercel/Netlify cho frontend
- MongoDB Atlas cluster
- Email service v·ªõi SendGrid/Gmail

---

**üéØ Outcome**: H·ªá th·ªëng User Management professional-grade, s·∫µn s√†ng cho production v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng enterprise.
